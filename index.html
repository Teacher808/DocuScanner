<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DocuScan Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        html, body { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; touch-action: none;
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #111827;
        }
        .hide { display: none !important; }
        .thumb-scroll::-webkit-scrollbar { width: 6px; }
        .thumb-scroll::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 10px; }
    </style>
</head>
<body class="text-white">

    <div id="app" class="relative w-full h-full">
        
        <!-- ========================================== -->
        <!-- 0. LOGIN OVERLAY                           -->
        <!-- ========================================== -->
        <div id="loginOverlay" class="absolute inset-0 z-[100] bg-gray-900 flex flex-col items-center justify-center p-6 hide">
            <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm border border-gray-700">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="ph ph-lock-key text-3xl text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white">Secure Login</h1>
                    <p class="text-sm text-gray-400 mt-2">Enter a username and password to access your secure Drive folder.</p>
                </div>
                <input type="text" id="usernameInput" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-blue-500 focus:outline-none mb-3 text-center" placeholder="Username">
                <input type="password" id="passwordInput" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-blue-500 focus:outline-none mb-4 text-center" placeholder="Password">
                <button id="loginBtn" class="w-full py-3 rounded-xl bg-blue-600 text-white font-medium hover:bg-blue-500 transition-colors flex justify-center items-center gap-2">
                    <span id="loginBtnText">Access My Scanner</span>
                    <i id="loginSpinner" class="ph ph-spinner animate-spin text-xl hide"></i>
                </button>
                
                <!-- Footnote -->
                <div class="text-center text-xs text-gray-500 mt-6 tracking-wide font-medium">
                    Developed by PVNJ
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- 1. CAMERA VIEW                             -->
        <!-- ========================================== -->
        <div id="cameraView" class="absolute inset-0 z-10 flex flex-col bg-black">
            <!-- Header -->
            <header class="absolute top-0 left-0 right-0 p-4 z-20 bg-gradient-to-b from-black/80 to-transparent flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-sm">U</div>
                    <span class="font-medium text-sm drop-shadow-md">User</span>
                </div>
                <div class="flex gap-2 items-center">
                    <button id="logoutBtn" class="text-red-400 hover:text-red-300 p-2 flex items-center justify-center bg-black/40 rounded-full backdrop-blur-md transition-colors shadow" title="Logout">
                        <i class="ph ph-sign-out text-xl"></i>
                    </button>
                    <button id="viewDriveBtn" class="text-blue-400 hover:text-blue-300 p-2 flex items-center justify-center bg-black/40 rounded-full backdrop-blur-md transition-colors shadow" title="My Files">
                        <i class="ph ph-folder-open text-xl"></i>
                    </button>
                    <button id="switchCameraBtn" class="text-gray-300 hover:text-white p-2 flex items-center justify-center bg-black/40 rounded-full backdrop-blur-md transition-colors shadow">
                        <i class="ph ph-camera-rotate text-xl"></i>
                    </button>
                </div>
            </header>

            <!-- Video Feed -->
            <video id="videoElement" class="w-full h-full object-cover" autoplay playsinline></video>
            
            <!-- Bottom Controls -->
            <div class="absolute bottom-0 left-0 right-0 p-6 pb-8 bg-gradient-to-t from-black to-transparent flex justify-center items-center z-20">
                <div class="flex items-center gap-8">
                    <!-- Placeholder to balance flex layout -->
                    <div class="w-14 h-14"></div>
                    
                    <!-- Capture Button -->
                    <button id="captureBtn" class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center bg-white/20 active:bg-white/60 transition-colors shadow-lg shadow-black/50">
                        <div class="w-16 h-16 rounded-full bg-white"></div>
                    </button>
                    
                    <!-- Viewer Access / Thumbnail -->
                    <button id="goToViewerBtn" class="relative w-14 h-14 rounded-xl overflow-hidden border-2 border-gray-400 bg-gray-800 flex items-center justify-center hide shadow-lg">
                        <img id="lastThumb" src="" class="w-full h-full object-cover hide">
                        <span id="pageBadge" class="absolute -top-2 -right-2 bg-blue-600 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full shadow hide">0</span>
                    </button>
                </div>
            </div>
            
            <!-- Hidden Canvas for capturing -->
            <canvas id="canvasElement" class="hide"></canvas>
        </div>

        <!-- ========================================== -->
        <!-- 2. VIEWER VIEW                             -->
        <!-- ========================================== -->
        <div id="viewerView" class="absolute inset-0 z-30 flex flex-col bg-gray-900 hide">
            <!-- Header -->
            <header class="p-4 flex justify-between items-center bg-gray-800 border-b border-gray-700 shadow-sm">
                <button id="backToCameraBtn" class="p-2 text-white hover:bg-gray-700 rounded-lg flex items-center gap-1 transition-colors">
                    <i class="ph ph-caret-left text-xl"></i> <span class="text-sm font-medium">Add More</span>
                </button>
                
                <button id="newScanBtn" class="p-2 text-red-400 hover:text-red-300 hover:bg-gray-700/50 rounded-lg flex items-center gap-1 transition-colors">
                    <i class="ph ph-file-dashed text-xl"></i> <span class="text-sm font-medium">New Scan</span>
                </button>
            </header>
            
            <!-- Image Carousel Area -->
            <div class="flex-1 relative flex items-center justify-center p-4 overflow-hidden">
                <img id="viewerImage" src="" class="max-w-full max-h-full object-contain shadow-2xl transition-transform">
                
                <!-- Pagination -->
                <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-6 items-center">
                    <button id="prevPageBtn" class="p-3 bg-black/70 rounded-full backdrop-blur text-white hover:bg-black transition-colors shadow-lg"><i class="ph ph-caret-left text-xl"></i></button>
                    <div class="bg-black/70 backdrop-blur text-white px-5 py-2 rounded-full font-medium shadow-lg tracking-wide" id="pageIndicator">1 / 1</div>
                    <button id="nextPageBtn" class="p-3 bg-black/70 rounded-full backdrop-blur text-white hover:bg-black transition-colors shadow-lg"><i class="ph ph-caret-right text-xl"></i></button>
                </div>
            </div>

            <!-- Bottom Actions -->
            <div class="bg-gray-800 p-4 pb-6 border-t border-gray-700 grid grid-cols-3 gap-2 shadow-[0_-10px_20px_rgba(0,0,0,0.2)]">
                <button id="exportPdfBtn" class="flex flex-col items-center gap-1.5 p-3 text-gray-300 hover:text-white rounded-xl hover:bg-gray-700 transition-colors">
                    <i class="ph ph-download-simple text-2xl"></i>
                    <span class="text-xs font-semibold">Save PDF</span>
                </button>
                <button id="exportJpgBtn" class="flex flex-col items-center gap-1.5 p-3 text-gray-300 hover:text-white rounded-xl hover:bg-gray-700 transition-colors">
                    <i class="ph ph-image text-2xl"></i>
                    <span class="text-xs font-semibold">Save JPG</span>
                </button>
                <button id="triggerDriveBtn" class="flex flex-col items-center gap-1.5 p-3 text-blue-400 hover:text-blue-300 rounded-xl hover:bg-gray-700 transition-colors">
                    <i class="ph ph-cloud-arrow-up text-2xl"></i>
                    <span class="text-xs font-semibold">Drive Upload</span>
                </button>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- 3. DRIVE UPLOAD MODAL                      -->
        <!-- ========================================== -->
        <div id="saveModal" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 hide backdrop-blur-sm">
            <div class="bg-gray-800 rounded-2xl w-full max-w-sm p-6 border border-gray-700 shadow-2xl">
                <h2 class="text-xl font-bold mb-4 text-white">Upload to Drive</h2>
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">Document Title</label>
                    <input type="text" id="docTitleInput" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-blue-500 focus:outline-none" placeholder="E.g., Tax Returns 2024">
                </div>
                <div class="mb-6">
                    <label class="block text-sm text-gray-400 mb-1">Save Format</label>
                    <select id="formatSelect" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-blue-500 focus:outline-none appearance-none">
                        <option value="pdf">Combine into Single PDF</option>
                        <option value="images">Separate Image Files</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button id="cancelSaveBtn" class="flex-1 py-3 rounded-xl bg-gray-700 text-white font-medium hover:bg-gray-600 transition-colors">Cancel</button>
                    <button id="confirmSaveBtn" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-medium hover:bg-blue-500 transition-colors flex items-center justify-center gap-2">
                        <i class="ph ph-upload-simple text-lg"></i> Upload
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- 4. MY FILES MODAL                          -->
        <!-- ========================================== -->
        <div id="filesModal" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 hide backdrop-blur-sm">
            <div class="bg-gray-800 rounded-2xl w-full max-w-sm p-6 border border-gray-700 max-h-[80vh] flex flex-col shadow-2xl">
                <h2 class="text-xl font-bold mb-4 text-white flex justify-between items-center">
                    My Drive Files
                    <button id="closeFilesBtn" class="text-gray-400 hover:text-white transition-colors"><i class="ph ph-x text-xl"></i></button>
                </h2>
                <div id="filesListContainer" class="flex-1 overflow-y-auto thumb-scroll flex flex-col pr-1">
                    <!-- Populated dynamically via JS -->
                </div>
            </div>
        </div>

        <!-- TOAST NOTIFICATION -->
        <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[60] px-6 py-3 rounded-full text-white font-medium text-sm transition-all duration-300 opacity-0 pointer-events-none transform -translate-y-4 shadow-lg shadow-black/40"></div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION & STATE
        // ==========================================
        // ⚠️ IMPORTANT: REPLACE THIS URL WITH YOUR GOOGLE APPS SCRIPT DEPLOYMENT URL
        const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbySF1GPjOnzpKZNLy0bu0pxE5Xl9wOyxInSdBXbzW-d2CS67fDeOfw8wSxciq4uJni7Zg/exec"; 
        
        let currentUser = localStorage.getItem('docuscan_user') || ""; 
        let currentPassword = localStorage.getItem('docuscan_pass') || "";
        
        let scannedPages = [];
        let viewerIndex = 0;
        let currentFacingMode = 'environment';
        let stream = null;

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        const el = id => document.getElementById(id);
        
        function showToast(msg, type = 'info') {
            const t = el('toast');
            t.textContent = msg;
            t.className = `fixed top-4 left-1/2 -translate-x-1/2 z-[60] px-6 py-3 rounded-full text-white font-medium text-sm transition-all duration-300 transform shadow-lg shadow-black/40 ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600'}`;
            t.classList.remove('opacity-0', '-translate-y-4');
            setTimeout(() => t.classList.add('opacity-0', '-translate-y-4'), 3000);
        }

        function updateUI() {
            if (scannedPages.length > 0) {
                el('goToViewerBtn').classList.remove('hide');
                el('lastThumb').src = scannedPages[scannedPages.length - 1];
                el('lastThumb').classList.remove('hide');
                el('pageBadge').classList.remove('hide');
                el('pageBadge').textContent = scannedPages.length;
            } else {
                el('goToViewerBtn').classList.add('hide');
                el('lastThumb').classList.add('hide');
                el('pageBadge').classList.add('hide');
            }
        }

        // ==========================================
        // LOGIN & LOGOUT LOGIC
        // ==========================================
        function checkLogin() {
            if (currentUser && currentPassword) {
                el('loginOverlay').classList.add('hide');
                const userInitial = currentUser.charAt(0).toUpperCase();
                
                // Update header UI with user details
                const headerInitialEl = document.querySelector('#cameraView header .w-8');
                const headerNameEl = document.querySelector('#cameraView header span');
                if (headerInitialEl) headerInitialEl.textContent = userInitial;
                if (headerNameEl) headerNameEl.textContent = currentUser;
                
                initCamera();
            }
        }

        el('loginBtn').addEventListener('click', async () => {
            const userVal = el('usernameInput').value.trim();
            const passVal = el('passwordInput').value.trim();
            
            if (userVal.length < 3 || passVal.length < 4) {
                showToast("Username min 3 chars, Password min 4 chars", "error");
                return;
            }

            if (!GOOGLE_APPS_SCRIPT_URL.includes("script.google.com")) {
                alert("Please add your Apps Script URL to the code before logging in.");
                return;
            }

            el('loginBtnText').textContent = "Authenticating...";
            el('loginSpinner').classList.remove('hide');
            el('loginBtn').disabled = true;

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'auth', username: userVal, password: passVal })
                });
                const result = await response.json();

                if (result.success) {
                    currentUser = userVal;
                    currentPassword = passVal;
                    localStorage.setItem('docuscan_user', currentUser);
                    localStorage.setItem('docuscan_pass', currentPassword);
                    showToast(result.message, "success");
                    checkLogin();
                } else {
                    showToast(result.error || "Authentication failed", "error");
                }
            } catch (err) {
                console.error(err);
                showToast("Network error. Try again.", "error");
            } finally {
                el('loginBtnText').textContent = "Access My Scanner";
                el('loginSpinner').classList.add('hide');
                el('loginBtn').disabled = false;
            }
        });

        // Logout logic - clears state, drops camera, and displays login
        el('logoutBtn').addEventListener('click', () => {
            currentUser = "";
            currentPassword = "";
            localStorage.removeItem('docuscan_user');
            localStorage.removeItem('docuscan_pass');
            
            // Clear inputs
            el('usernameInput').value = '';
            el('passwordInput').value = '';
            
            // Reset app state
            scannedPages = [];
            viewerIndex = 0;
            updateUI();
            el('viewerView').classList.add('hide');
            el('cameraView').classList.remove('hide');
            
            // Stop the camera to save resources while logged out
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            el('loginOverlay').classList.remove('hide');
            showToast("Logged out successfully", "success");
        });

        // Initialize App & Login Check
        if (!currentUser) {
            el('loginOverlay').classList.remove('hide');
        } else {
            checkLogin();
        }

        // ==========================================
        // CAMERA LOGIC
        // ==========================================
        async function initCamera() {
            if (!currentUser) return; // Prevent camera init if not logged in
            if (stream) stream.getTracks().forEach(track => track.stop());
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: currentFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } } 
                });
                el('videoElement').srcObject = stream;
            } catch (err) {
                console.error("Camera Error:", err);
                showToast("Cannot access camera", "error");
            }
        }

        el('switchCameraBtn').addEventListener('click', () => {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            initCamera();
        });

        el('captureBtn').addEventListener('click', () => {
            const video = el('videoElement');
            const canvas = el('canvasElement');
            // Flash animation
            const flash = document.createElement('div');
            flash.className = 'absolute inset-0 bg-white z-50 transition-opacity duration-300 pointer-events-none opacity-100';
            el('cameraView').appendChild(flash);
            setTimeout(() => flash.classList.add('opacity-0'), 50);
            setTimeout(() => flash.remove(), 350);

            // Capture high-res frame
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            scannedPages.push(canvas.toDataURL('image/jpeg', 0.85));
            updateUI();
        });

        // ==========================================
        // VIEWER LOGIC
        // ==========================================
        function showViewer() {
            el('cameraView').classList.add('hide');
            el('viewerView').classList.remove('hide');
            viewerIndex = scannedPages.length - 1; // Show newest scan first
            updateView();
        }

        function updateView() {
            if (scannedPages.length === 0) return;
            el('viewerImage').src = scannedPages[viewerIndex];
            el('pageIndicator').textContent = `${viewerIndex + 1} / ${scannedPages.length}`;
            
            el('prevPageBtn').style.opacity = viewerIndex === 0 ? '0.3' : '1';
            el('nextPageBtn').style.opacity = viewerIndex === scannedPages.length - 1 ? '0.3' : '1';
        }

        el('goToViewerBtn').addEventListener('click', showViewer);
        
        el('backToCameraBtn').addEventListener('click', () => {
            el('viewerView').classList.add('hide');
            el('cameraView').classList.remove('hide');
        });

        el('prevPageBtn').addEventListener('click', () => {
            if (viewerIndex > 0) { viewerIndex--; updateView(); }
        });
        
        el('nextPageBtn').addEventListener('click', () => {
            if (viewerIndex < scannedPages.length - 1) { viewerIndex++; updateView(); }
        });

        el('newScanBtn').addEventListener('click', () => {
            if(scannedPages.length > 0) {
                if(!confirm("Are you sure you want to discard these pages and start a new scan? Unsaved changes will be lost.")) {
                    return;
                }
            }
            scannedPages = [];
            viewerIndex = 0;
            updateUI();
            el('viewerView').classList.add('hide');
            el('cameraView').classList.remove('hide');
            el('docTitleInput').value = ''; 
            showToast("Ready for a new document", "success");
        });

        // ==========================================
        // PDF BUILDER (8.5 x 11 Logic)
        // ==========================================
        async function buildPDF() {
            if (scannedPages.length === 0) throw new Error("No pages to export");
            const { jsPDF } = window.jspdf;
            
            const doc = new jsPDF({ unit: 'in', format: 'letter' });
            
            for (let i = 0; i < scannedPages.length; i++) {
                if (i > 0) doc.addPage();
                
                const imgProps = doc.getImageProperties(scannedPages[i]);
                const pdfWidth = doc.internal.pageSize.getWidth();   // 8.5
                const pdfHeight = doc.internal.pageSize.getHeight(); // 11
                
                let imgWidth = pdfWidth;
                let imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                if (imgHeight > pdfHeight) {
                    imgHeight = pdfHeight;
                    imgWidth = (imgProps.width * pdfHeight) / imgProps.height;
                }
                
                const x = (pdfWidth - imgWidth) / 2;
                const y = (pdfHeight - imgHeight) / 2;
                
                doc.addImage(scannedPages[i], 'JPEG', x, y, imgWidth, imgHeight);
            }
            return doc;
        }

        // ==========================================
        // EXPORT LOCALLY
        // ==========================================
        el('exportPdfBtn').addEventListener('click', async () => {
            if(scannedPages.length === 0) return;
            showToast("Generating PDF...", "info");
            try {
                const doc = await buildPDF();
                doc.save(`DocuScan_${new Date().getTime()}.pdf`);
                showToast("PDF Downloaded!", "success");
            } catch(e) { showToast("PDF Error", "error"); console.error(e); }
        });

        el('exportJpgBtn').addEventListener('click', () => {
            if(scannedPages.length === 0) return;
            const link = document.createElement('a');
            link.download = `Page_${viewerIndex + 1}.jpg`;
            link.href = scannedPages[viewerIndex];
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Image Downloaded!", "success");
        });

        // ==========================================
        // DRIVE UPLOAD LOGIC
        // ==========================================
        el('triggerDriveBtn').addEventListener('click', () => {
            if(scannedPages.length === 0) return;
            el('saveModal').classList.remove('hide');
        });
        
        el('cancelSaveBtn').addEventListener('click', () => el('saveModal').classList.add('hide'));

        el('confirmSaveBtn').addEventListener('click', async () => {
            if (!GOOGLE_APPS_SCRIPT_URL.includes("script.google.com")) {
                alert("Please add your Apps Script URL to the code before testing Drive features.");
                return;
            }

            const title = el('docTitleInput').value.trim() || 'Untitled Scan';
            const format = el('formatSelect').value;
            
            el('saveModal').classList.add('hide');
            showToast("Preparing file...", "info");
            
            let payload = { action: 'save', username: currentUser, password: currentPassword, title: title, format: format };
            
            try {
                if (format === 'pdf') {
                    const doc = await buildPDF();
                    payload.file = doc.output('datauristring');
                } else {
                    payload.pages = scannedPages;
                }
                
                showToast("Uploading to Drive...", "info");
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast("Uploaded successfully!", "success");
                } else {
                    throw new Error(result.error);
                }
            } catch (err) {
                console.error(err);
                showToast("Upload failed.", "error");
            }
        });

        // ==========================================
        // MY FILES VIEWER LOGIC
        // ==========================================
        el('viewDriveBtn').addEventListener('click', async () => {
            if (!GOOGLE_APPS_SCRIPT_URL.includes("script.google.com")) {
                alert("Please add your Apps Script URL to the code before checking Drive files.");
                return;
            }

            const container = el('filesListContainer');
            el('filesModal').classList.remove('hide');
            
            container.innerHTML = '<div class="text-center text-gray-400 py-12"><i class="ph ph-spinner animate-spin text-3xl mb-3 text-blue-500"></i><br>Fetching your files...</div>';

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'list_files', username: currentUser, password: currentPassword })
                });
                const result = await response.json();
                
                if (result.success) {
                    if (result.files.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-400 py-10">No files found in your Drive yet.</div>';
                    } else {
                        container.innerHTML = result.files.map(f => `
                            <a href="${f.url}" target="_blank" class="flex items-center gap-4 p-3 bg-gray-900 rounded-xl hover:bg-gray-700 transition-colors border border-gray-700 mb-2 no-underline text-white">
                                <div class="${f.type === 'folder' ? 'text-yellow-400' : 'text-red-400'} text-3xl">
                                    <i class="ph ${f.type === 'folder' ? 'ph-folder' : 'ph-file-pdf'}"></i>
                                </div>
                                <div class="flex-1 overflow-hidden">
                                    <div class="text-sm font-semibold truncate">${f.name}</div>
                                    <div class="text-xs text-gray-400 mt-1">${new Date(f.date).toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                                </div>
                                <i class="ph ph-arrow-square-out text-gray-400 text-lg"></i>
                            </a>
                        `).join('');
                    }
                } else { throw new Error(result.error); }
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div class="text-center text-red-400 py-10">Failed to load files.<br>Check your connection and Script URL.</div>';
            }
        });

        el('closeFilesBtn').addEventListener('click', () => el('filesModal').classList.add('hide'));

    </script>
</body>
</html>
