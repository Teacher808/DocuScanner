<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DocuScan Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- OpenCV.js for Computer Vision -->
    <script>
        var Module = {
            onRuntimeInitialized: function() {
                window.cvReady = true;
                const cvStatus = document.getElementById('cvStatus');
                if(cvStatus) {
                    cvStatus.textContent = "AI Engine Ready (Auto-detect active)";
                    cvStatus.classList.remove('text-yellow-400');
                    cvStatus.classList.add('text-green-400');
                }
            }
        };
    </script>
    <script async src="https://docs.opencv.org/4.8.0/opencv.js"></script>

    <style>
        html, body { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; touch-action: none;
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #111827;
        }
        .hide { display: none !important; }
        .thumb-scroll::-webkit-scrollbar { width: 6px; }
        .thumb-scroll::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 10px; }
    </style>
</head>
<body class="text-white">

    <div id="app" class="relative w-full h-full">
        
        <!-- ========================================== -->
        <!-- 0. LOGIN / REGISTER OVERLAY                -->
        <!-- ========================================== -->
        <div id="loginOverlay" class="absolute inset-0 z-[100] bg-gray-900 flex flex-col items-center justify-center p-6 hide">
            <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm border border-gray-700 relative">
                
                <div id="offlineAuthIndicator" class="absolute -top-3 left-1/2 -translate-x-1/2 bg-yellow-600 text-white text-[10px] uppercase font-bold px-3 py-1 rounded-full shadow-lg hide flex items-center gap-1 tracking-wider">
                    <i class="ph ph-wifi-slash"></i> Offline Mode
                </div>

                <div class="text-center mb-6 mt-2">
                    <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 transition-colors" id="authIconContainer">
                        <i id="authIcon" class="ph ph-lock-key text-3xl text-white"></i>
                    </div>
                    <h1 id="authTitle" class="text-2xl font-bold text-white">Document Scanner</h1>
                    <p id="authSubtitle" class="text-sm text-gray-400 mt-2">Enter your credentials to access your secure Drive.</p>
                </div>
                
                <input type="text" id="usernameInput" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-blue-500 focus:outline-none mb-3 text-center" placeholder="Username" autocomplete="username">
                
                <div class="relative mb-3">
                    <input type="password" id="passwordInput" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 pr-10 text-white focus:border-blue-500 focus:outline-none text-center" placeholder="Password" autocomplete="current-password">
                    <button type="button" id="togglePasswordBtn" class="absolute right-3 top-3.5 text-gray-400 hover:text-white transition-colors" title="Show/Hide Password">
                        <i class="ph ph-eye text-xl"></i>
                    </button>
                </div>

                <div id="confirmPasswordContainer" class="relative mb-4 hide">
                    <input type="password" id="confirmPasswordInput" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 pr-10 text-white focus:border-blue-500 focus:outline-none text-center" placeholder="Confirm Password" autocomplete="new-password">
                    <button type="button" id="toggleConfirmPasswordBtn" class="absolute right-3 top-3.5 text-gray-400 hover:text-white transition-colors" title="Show/Hide Password">
                        <i class="ph ph-eye text-xl"></i>
                    </button>
                </div>

                <button id="loginBtn" class="w-full py-3 mt-1 rounded-xl bg-blue-600 text-white font-medium hover:bg-blue-500 transition-colors flex justify-center items-center gap-2">
                    <span id="loginBtnText">Access My Scanner</span>
                    <i id="loginSpinner" class="ph ph-spinner animate-spin text-xl hide"></i>
                </button>
                
                <div class="text-center mt-5">
                    <button id="toggleAuthModeBtn" class="text-sm text-blue-400 hover:text-blue-300 transition-colors font-medium">Need an account? Register</button>
                </div>
            </div>
            
            <!-- Login Footer -->
            <div class="absolute bottom-8 left-0 right-0 text-center text-gray-500 text-sm font-medium tracking-wider pointer-events-none">
                Developed by PVNJ
            </div>
        </div>

        <!-- ========================================== -->
        <!-- 1. CAMERA VIEW                             -->
        <!-- ========================================== -->
        <div id="cameraView" class="absolute inset-0 z-10 flex flex-col bg-black">
            <header class="absolute top-0 left-0 right-0 p-4 z-20 bg-gradient-to-b from-black/80 to-transparent flex justify-between items-center pointer-events-none">
                <div class="flex items-center gap-2 pointer-events-auto">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-sm">U</div>
                    <span class="font-medium text-sm drop-shadow-md flex items-center gap-2">
                        <span id="headerUsername">User</span>
                        <i id="headerOfflineIcon" class="ph ph-wifi-slash text-yellow-400 hide" title="Offline Mode"></i>
                    </span>
                </div>
                <div class="flex gap-2 items-center pointer-events-auto">
                    <button id="logoutBtn" class="text-red-400 hover:text-red-300 p-2 flex items-center justify-center bg-black/40 rounded-full backdrop-blur-md transition-colors shadow" title="Logout">
                        <i class="ph ph-sign-out text-xl"></i>
                    </button>
                    <button id="viewDriveBtn" class="text-blue-400 hover:text-blue-300 p-2 flex items-center justify-center bg-black/40 rounded-full backdrop-blur-md transition-colors shadow" title="My Files">
                        <i class="ph ph-folder-open text-xl"></i>
                    </button>
                    <!-- Flashlight Toggle -->
                    <button id="toggleFlashBtn" class="text-gray-300 hover:text-white p-2 flex items-center justify-center bg-black/40 rounded-full backdrop-blur-md transition-colors shadow hide" title="Toggle Flashlight">
                        <i id="flashIcon" class="ph ph-flashlight text-xl"></i>
                    </button>
                    <button id="switchCameraBtn" class="text-gray-300 hover:text-white p-2 flex items-center justify-center bg-black/40 rounded-full backdrop-blur-md transition-colors shadow" title="Switch Camera">
                        <i class="ph ph-camera-rotate text-xl"></i>
                    </button>
                </div>
            </header>

            <video id="videoElement" class="w-full h-full object-cover" autoplay playsinline></video>
            
            <div class="absolute bottom-0 left-0 right-0 p-6 pb-8 bg-gradient-to-t from-black to-transparent flex justify-center items-center z-20">
                <div class="flex items-center gap-8">
                    <div class="w-14 h-14"></div> <!-- Spacer -->
                    
                    <button id="captureBtn" class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center bg-white/20 active:bg-white/60 transition-colors shadow-lg shadow-black/50">
                        <div class="w-16 h-16 rounded-full bg-white"></div>
                    </button>
                    
                    <button id="goToViewerBtn" class="relative w-14 h-14 rounded-xl overflow-hidden border-2 border-gray-400 bg-gray-800 flex items-center justify-center hide shadow-lg">
                        <img id="lastThumb" src="" class="w-full h-full object-cover hide">
                        <span id="pageBadge" class="absolute -top-2 -right-2 bg-blue-600 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full shadow hide">0</span>
                    </button>
                </div>
            </div>
            
            <canvas id="canvasElement" class="hide"></canvas>
        </div>

        <!-- ========================================== -->
        <!-- 2. CROP & ADJUST VIEW                      -->
        <!-- ========================================== -->
        <div id="cropView" class="absolute inset-0 z-40 bg-gray-900 flex flex-col hide">
            <header class="p-4 flex justify-between items-center bg-gray-800 border-b border-gray-700 shadow-sm z-10">
                <button id="cancelCropBtn" class="p-2 text-red-400 hover:bg-gray-700 rounded-lg flex items-center gap-1 transition-colors">
                    <i class="ph ph-x text-xl"></i> <span class="text-sm font-medium">Retake</span>
                </button>
                <div class="text-white font-medium">Adjust Edges</div>
                <button id="confirmCropBtn" class="p-2 text-blue-400 hover:bg-gray-700 rounded-lg flex items-center gap-1 transition-colors">
                    <span class="text-sm font-medium">Done</span> <i class="ph ph-check text-xl"></i>
                </button>
            </header>

            <div id="cropContainer" class="relative w-full flex-1 bg-black overflow-hidden touch-none">
                <img id="cropImage" class="absolute pointer-events-none origin-top-left object-cover">
                <svg id="cropSvg" class="absolute inset-0 pointer-events-none w-full h-full z-10">
                    <polygon id="cropPolygon" points="" fill="rgba(59, 130, 246, 0.2)" stroke="#3b82f6" stroke-width="2"/>
                </svg>
                
                <div id="pt0" class="crop-pt absolute w-12 h-12 -ml-6 -mt-6 bg-blue-500/40 border-2 border-white rounded-full flex items-center justify-center cursor-pointer touch-none z-20 shadow-[0_0_10px_rgba(0,0,0,0.5)]"><div class="w-3 h-3 bg-white rounded-full"></div></div>
                <div id="pt1" class="crop-pt absolute w-12 h-12 -ml-6 -mt-6 bg-blue-500/40 border-2 border-white rounded-full flex items-center justify-center cursor-pointer touch-none z-20 shadow-[0_0_10px_rgba(0,0,0,0.5)]"><div class="w-3 h-3 bg-white rounded-full"></div></div>
                <div id="pt2" class="crop-pt absolute w-12 h-12 -ml-6 -mt-6 bg-blue-500/40 border-2 border-white rounded-full flex items-center justify-center cursor-pointer touch-none z-20 shadow-[0_0_10px_rgba(0,0,0,0.5)]"><div class="w-3 h-3 bg-white rounded-full"></div></div>
                <div id="pt3" class="crop-pt absolute w-12 h-12 -ml-6 -mt-6 bg-blue-500/40 border-2 border-white rounded-full flex items-center justify-center cursor-pointer touch-none z-20 shadow-[0_0_10px_rgba(0,0,0,0.5)]"><div class="w-3 h-3 bg-white rounded-full"></div></div>
            </div>
            
            <div class="bg-gray-800 p-4 border-t border-gray-700 text-center text-xs text-gray-400 shadow-[0_-10px_20px_rgba(0,0,0,0.2)] z-10">
                Drag the corners to accurately match the document edges.
                <div id="cvStatus" class="mt-1 font-semibold text-yellow-400 transition-colors">AI Engine Loading...</div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- 3. VIEWER VIEW                             -->
        <!-- ========================================== -->
        <div id="viewerView" class="absolute inset-0 z-30 flex flex-col bg-gray-900 hide">
            <header class="p-4 flex justify-between items-center bg-gray-800 border-b border-gray-700 shadow-sm z-20">
                <button id="backToCameraBtn" class="p-2 text-white hover:bg-gray-700 rounded-lg flex items-center gap-1 transition-colors">
                    <i class="ph ph-caret-left text-xl"></i> <span class="text-sm font-medium">Add More</span>
                </button>
                <button id="newScanBtn" class="p-2 text-red-400 hover:text-red-300 hover:bg-gray-700/50 rounded-lg flex items-center gap-1 transition-colors">
                    <i class="ph ph-file-dashed text-xl"></i> <span class="text-sm font-medium">New Scan</span>
                </button>
            </header>
            
            <div class="flex-1 relative flex items-center justify-center p-4 overflow-hidden">
                <img id="viewerImage" src="" class="max-w-full max-h-full object-contain shadow-2xl transition-all duration-150 bg-white">
            </div>

            <!-- Image Controls (Filters & Brightness) -->
            <div class="bg-gray-800 px-4 py-3 border-t border-gray-700 shadow-[0_-10px_20px_rgba(0,0,0,0.2)] z-20">
                
                <!-- Brightness Slider -->
                <div class="flex items-center gap-3 mb-3">
                    <i class="ph ph-sun-dim text-gray-400 text-lg"></i>
                    <input type="range" id="brightnessSlider" min="50" max="200" value="100" class="flex-1 accent-blue-500 cursor-pointer">
                    <i class="ph ph-sun text-gray-400 text-lg"></i>
                </div>
                
                <div class="flex items-center justify-between">
                    <!-- Filter Toggles -->
                    <div class="flex bg-gray-900 rounded-lg p-1 shadow-inner">
                        <button data-filter="original" class="filter-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-blue-600 text-white shadow transition-colors">Color</button>
                        <button data-filter="grayscale" class="filter-btn px-3 py-1.5 text-xs font-semibold rounded-md text-gray-400 bg-transparent hover:text-white transition-colors">Gray</button>
                        <button data-filter="bw" class="filter-btn px-3 py-1.5 text-xs font-semibold rounded-md text-gray-400 bg-transparent hover:text-white transition-colors">B&W</button>
                    </div>

                    <!-- Pagination -->
                    <div class="flex items-center gap-3">
                        <button id="prevPageBtn" class="p-1.5 bg-gray-700 rounded-lg text-white hover:bg-gray-600 transition-colors disabled:opacity-30 disabled:pointer-events-none"><i class="ph ph-caret-left text-lg"></i></button>
                        <div class="text-white font-medium text-xs w-10 text-center" id="pageIndicator">1 / 1</div>
                        <button id="nextPageBtn" class="p-1.5 bg-gray-700 rounded-lg text-white hover:bg-gray-600 transition-colors disabled:opacity-30 disabled:pointer-events-none"><i class="ph ph-caret-right text-lg"></i></button>
                    </div>
                </div>
            </div>

            <!-- Export Buttons -->
            <div class="bg-gray-800 p-4 pb-6 border-t border-gray-700 grid grid-cols-3 gap-2 z-20">
                <button id="exportPdfBtn" class="flex flex-col items-center gap-1.5 p-3 text-gray-300 hover:text-white rounded-xl hover:bg-gray-700 transition-colors">
                    <i class="ph ph-download-simple text-2xl"></i>
                    <span class="text-xs font-semibold">Save PDF</span>
                </button>
                <button id="exportJpgBtn" class="flex flex-col items-center gap-1.5 p-3 text-gray-300 hover:text-white rounded-xl hover:bg-gray-700 transition-colors">
                    <i class="ph ph-image text-2xl"></i>
                    <span class="text-xs font-semibold">Save JPG</span>
                </button>
                <button id="triggerDriveBtn" class="flex flex-col items-center gap-1.5 p-3 text-blue-400 hover:text-blue-300 rounded-xl hover:bg-gray-700 transition-colors">
                    <i id="driveBtnIcon" class="ph ph-cloud-arrow-up text-2xl"></i>
                    <span id="driveBtnText" class="text-xs font-semibold">Drive Upload</span>
                </button>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- 4. MODALS & TOASTS                         -->
        <!-- ========================================== -->
        <div id="saveModal" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 hide backdrop-blur-sm">
            <div class="bg-gray-800 rounded-2xl w-full max-w-sm p-6 border border-gray-700 shadow-2xl">
                <h2 class="text-xl font-bold mb-4 text-white">Upload to Drive</h2>
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">Document Title</label>
                    <input type="text" id="docTitleInput" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-blue-500 focus:outline-none" placeholder="E.g., Tax Returns 2024">
                </div>
                <div class="mb-6">
                    <label class="block text-sm text-gray-400 mb-1">Save Format</label>
                    <select id="formatSelect" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-blue-500 focus:outline-none appearance-none">
                        <option value="pdf">Combine into Single PDF</option>
                        <option value="images">Separate Image Files</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button id="cancelSaveBtn" class="flex-1 py-3 rounded-xl bg-gray-700 text-white font-medium hover:bg-gray-600 transition-colors">Cancel</button>
                    <button id="confirmSaveBtn" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-medium hover:bg-blue-500 transition-colors flex items-center justify-center gap-2">
                        <i class="ph ph-upload-simple text-lg"></i> Upload
                    </button>
                </div>
            </div>
        </div>

        <div id="filesModal" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 hide backdrop-blur-sm">
            <div class="bg-gray-800 rounded-2xl w-full max-w-sm p-6 border border-gray-700 max-h-[80vh] flex flex-col shadow-2xl">
                <h2 class="text-xl font-bold mb-4 text-white flex justify-between items-center">
                    My Drive Files
                    <button id="closeFilesBtn" class="text-gray-400 hover:text-white transition-colors"><i class="ph ph-x text-xl"></i></button>
                </h2>
                <div id="filesListContainer" class="flex-1 overflow-y-auto thumb-scroll flex flex-col pr-1"></div>
            </div>
        </div>

        <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-full text-white font-medium text-sm transition-all duration-300 opacity-0 pointer-events-none transform -translate-y-4 shadow-lg shadow-black/40"></div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION & STATE
        // ==========================================
        const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbySF1GPjOnzpKZNLy0bu0pxE5Xl9wOyxInSdBXbzW-d2CS67fDeOfw8wSxciq4uJni7Zg/exec"; 
        
        let currentUser = localStorage.getItem('docuscan_user') || ""; 
        let currentPassword = localStorage.getItem('docuscan_pass') || "";
        
        // scannedPages now holds objects: { originalDataUrl, displayDataUrl, filter, brightness }
        let scannedPages = [];
        let viewerIndex = 0;
        let currentFacingMode = 'environment';
        let stream = null;
        let isRegisterMode = false;
        let isFlashOn = false;
        window.cvReady = window.cvReady || false;

        const el = id => document.getElementById(id);
        
        // --- OFFLINE / ONLINE DETECTION ---
        function updateNetworkStatus() {
            const isOnline = navigator.onLine;
            if (!isOnline) {
                el('offlineAuthIndicator').classList.remove('hide');
                el('headerOfflineIcon').classList.remove('hide');
                el('triggerDriveBtn').classList.replace('text-blue-400', 'text-gray-500');
                el('triggerDriveBtn').classList.replace('hover:text-blue-300', 'hover:text-gray-400');
                el('driveBtnIcon').classList.replace('ph-cloud-arrow-up', 'ph-cloud-slash');
                el('viewDriveBtn').classList.replace('text-blue-400', 'text-gray-500');
                el('viewDriveBtn').classList.replace('hover:text-blue-300', 'hover:text-gray-400');
            } else {
                el('offlineAuthIndicator').classList.add('hide');
                el('headerOfflineIcon').classList.add('hide');
                el('triggerDriveBtn').classList.replace('text-gray-500', 'text-blue-400');
                el('triggerDriveBtn').classList.replace('hover:text-gray-400', 'hover:text-blue-300');
                el('driveBtnIcon').classList.replace('ph-cloud-slash', 'ph-cloud-arrow-up');
                el('viewDriveBtn').classList.replace('text-gray-500', 'text-blue-400');
                el('viewDriveBtn').classList.replace('hover:text-gray-400', 'hover:text-blue-300');
            }
        }
        window.addEventListener('online', () => { updateNetworkStatus(); showToast("Back Online! Drive Sync available.", "success"); });
        window.addEventListener('offline', () => { updateNetworkStatus(); showToast("You are offline. Saving locally only.", "error"); });
        updateNetworkStatus();

        function showToast(msg, type = 'info') {
            const t = el('toast');
            t.textContent = msg;
            t.className = `fixed top-4 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-full text-white font-medium text-sm transition-all duration-300 transform shadow-lg shadow-black/40 ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600'}`;
            t.classList.remove('opacity-0', '-translate-y-4');
            setTimeout(() => t.classList.add('opacity-0', '-translate-y-4'), 3000);
        }

        function updateUI() {
            if (scannedPages.length > 0) {
                el('goToViewerBtn').classList.remove('hide');
                el('lastThumb').src = scannedPages[scannedPages.length - 1].displayDataUrl;
                el('lastThumb').classList.remove('hide');
                el('pageBadge').classList.remove('hide');
                el('pageBadge').textContent = scannedPages.length;
            } else {
                el('goToViewerBtn').classList.add('hide');
                el('lastThumb').classList.add('hide');
                el('pageBadge').classList.add('hide');
            }
        }

        // ==========================================
        // LOGIN / REGISTRATION LOGIC
        // ==========================================
        function setupPasswordToggle(inputId, btnId) {
            const input = el(inputId); const btn = el(btnId); const icon = btn.querySelector('i');
            btn.addEventListener('click', () => {
                if (input.type === 'password') {
                    input.type = 'text'; icon.classList.remove('ph-eye'); icon.classList.add('ph-eye-slash'); btn.classList.add('text-blue-400');
                } else {
                    input.type = 'password'; icon.classList.remove('ph-eye-slash'); icon.classList.add('ph-eye'); btn.classList.remove('text-blue-400');
                }
            });
        }
        setupPasswordToggle('passwordInput', 'togglePasswordBtn');
        setupPasswordToggle('confirmPasswordInput', 'toggleConfirmPasswordBtn');

        el('toggleAuthModeBtn').addEventListener('click', () => {
            isRegisterMode = !isRegisterMode;
            if (isRegisterMode) {
                el('authTitle').textContent = "Create Account";
                el('authSubtitle').textContent = "Register a new secure username and password.";
                el('confirmPasswordContainer').classList.remove('hide');
                el('loginBtnText').textContent = "Register & Access";
                el('toggleAuthModeBtn').textContent = "Already have an account? Login";
                el('authIconContainer').classList.replace('bg-blue-600', 'bg-green-600');
                el('authIcon').className = "ph ph-user-plus text-3xl text-white";
            } else {
                el('authTitle').textContent = "Document Scanner";
                el('authSubtitle').textContent = "Enter your credentials to access your secure Drive.";
                el('confirmPasswordContainer').classList.add('hide');
                el('loginBtnText').textContent = "Access My Scanner";
                el('toggleAuthModeBtn').textContent = "Need an account? Register";
                el('authIconContainer').classList.replace('bg-green-600', 'bg-blue-600');
                el('authIcon').className = "ph ph-lock-key text-3xl text-white";
                el('confirmPasswordInput').value = "";
            }
        });

        function checkLogin() {
            if (currentUser && currentPassword) {
                el('loginOverlay').classList.add('hide');
                const userInitial = currentUser.charAt(0).toUpperCase();
                const headerInitialEl = document.querySelector('#cameraView header .w-8');
                el('headerUsername').textContent = currentUser;
                if (headerInitialEl) headerInitialEl.textContent = userInitial;
                initCamera();
            }
        }

        el('loginBtn').addEventListener('click', async () => {
            const userVal = el('usernameInput').value.trim();
            const passVal = el('passwordInput').value.trim();
            const confirmPassVal = el('confirmPasswordInput').value.trim();

            if (userVal.length < 3) return showToast("Username must be at least 3 characters", "error");
            if (passVal.length < 4) return showToast("Password must be at least 4 characters", "error");
            if (isRegisterMode && passVal !== confirmPassVal) return showToast("Passwords do not match!", "error");

            if (!navigator.onLine) {
                if (isRegisterMode) return showToast("Cannot create new accounts offline.", "error");
                const savedUser = localStorage.getItem('docuscan_user');
                const savedPass = localStorage.getItem('docuscan_pass');
                if (userVal === savedUser && passVal === savedPass) {
                    showToast("Offline Login Successful", "success");
                    currentUser = userVal; currentPassword = passVal; checkLogin();
                } else showToast("Offline: Incorrect credentials", "error");
                return;
            }

            el('loginBtnText').textContent = isRegisterMode ? "Registering..." : "Authenticating...";
            el('loginSpinner').classList.remove('hide');
            el('loginBtn').disabled = true;

            try {
                const actionType = isRegisterMode ? 'register' : 'auth';
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, { 
                    method: 'POST', body: JSON.stringify({ action: actionType, username: userVal, password: passVal }) 
                });
                const result = await response.json();
                
                if (result.success) {
                    currentUser = userVal; currentPassword = passVal;
                    localStorage.setItem('docuscan_user', currentUser); 
                    localStorage.setItem('docuscan_pass', currentPassword);
                    showToast(isRegisterMode ? "Account Created!" : result.message, "success"); 
                    checkLogin();
                } else showToast(result.error || "Authentication failed", "error");
            } catch (err) { showToast("Network error. Try going offline.", "error"); 
            } finally { 
                el('loginBtnText').textContent = isRegisterMode ? "Register & Access" : "Access My Scanner"; 
                el('loginSpinner').classList.add('hide'); el('loginBtn').disabled = false; 
            }
        });

        el('logoutBtn').addEventListener('click', () => {
            currentUser = ""; currentPassword = "";
            el('usernameInput').value = ''; el('passwordInput').value = ''; el('confirmPasswordInput').value = '';
            if(isRegisterMode) el('toggleAuthModeBtn').click();
            scannedPages = []; viewerIndex = 0; updateUI();
            el('viewerView').classList.add('hide'); el('cropView').classList.add('hide'); el('cameraView').classList.remove('hide');
            if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
            el('loginOverlay').classList.remove('hide'); showToast("Logged out successfully", "success");
        });

        if (!currentUser) el('loginOverlay').classList.remove('hide'); else checkLogin();

        // ==========================================
        // CAMERA & FLASH LOGIC
        // ==========================================
        async function initCamera() {
            if (!currentUser) return;
            if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } } });
                el('videoElement').srcObject = stream;
                
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities ? track.getCapabilities() : null;
                if (capabilities && capabilities.torch) {
                    el('toggleFlashBtn').classList.remove('hide');
                    isFlashOn = false; updateFlashIconUI();
                } else {
                    el('toggleFlashBtn').classList.add('hide');
                    isFlashOn = false;
                }
            } catch (err) { showToast("Cannot access camera", "error"); }
        }

        function updateFlashIconUI() {
            const icon = el('flashIcon'); const btn = el('toggleFlashBtn');
            if (isFlashOn) {
                icon.classList.replace('ph-flashlight', 'ph-flashlight-fill');
                btn.classList.replace('text-gray-300', 'text-yellow-400');
            } else {
                icon.classList.replace('ph-flashlight-fill', 'ph-flashlight');
                btn.classList.replace('text-yellow-400', 'text-gray-300');
            }
        }

        el('toggleFlashBtn').addEventListener('click', async () => {
            if (!stream) return;
            const track = stream.getVideoTracks()[0];
            try {
                isFlashOn = !isFlashOn;
                await track.applyConstraints({ advanced: [{ torch: isFlashOn }] });
                updateFlashIconUI();
            } catch (err) {
                showToast("Failed to toggle flash", "error");
                isFlashOn = !isFlashOn; updateFlashIconUI();
            }
        });

        el('switchCameraBtn').addEventListener('click', () => { currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment'; initCamera(); });

        el('captureBtn').addEventListener('click', () => {
            const video = el('videoElement'); const canvas = el('canvasElement');
            const flash = document.createElement('div');
            flash.className = 'absolute inset-0 bg-white z-50 transition-opacity duration-300 pointer-events-none opacity-100';
            el('cameraView').appendChild(flash);
            setTimeout(() => flash.classList.add('opacity-0'), 50); setTimeout(() => flash.remove(), 350);

            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            initCrop(canvas);
        });

        // ==========================================
        // CROP & COMPUTER VISION LOGIC
        // ==========================================
        let currentCropCanvas = null;
        let cropImgBaseW = 0; let cropImgBaseH = 0;
        let cropScale = 1; let cropOffsetX = 0; let cropOffsetY = 0;
        let activePtIndex = -1; let cropPts = []; 

        function initCrop(canvas) {
            if (isFlashOn && stream) {
                isFlashOn = false; stream.getVideoTracks()[0].applyConstraints({ advanced: [{ torch: false }] }).catch(()=>{});
                updateFlashIconUI();
            }

            el('cameraView').classList.add('hide'); el('cropView').classList.remove('hide');
            currentCropCanvas = canvas; cropImgBaseW = canvas.width; cropImgBaseH = canvas.height;
            el('cropImage').src = canvas.toDataURL('image/jpeg', 0.8);

            let detectedPts = null;
            if (window.cvReady) {
                showToast("Scanning for document edges...", "info");
                setTimeout(() => { detectedPts = findDocumentCorners(canvas); setupCropUI(detectedPts); }, 50);
            } else { setupCropUI(null); }
        }

        function setupCropUI(detectedPts) {
            if (detectedPts && detectedPts.length === 4) { cropPts = detectedPts; showToast("Document detected!", "success"); } 
            else {
                let mw = cropImgBaseW * 0.1; let mh = cropImgBaseH * 0.1;
                cropPts = [ {x: mw, y: mh}, {x: cropImgBaseW - mw, y: mh}, {x: cropImgBaseW - mw, y: cropImgBaseH - mh}, {x: mw, y: cropImgBaseH - mh} ];
                if(window.cvReady) showToast("Could not auto-detect edges. Adjust manually.", "info");
            }
            el('cropImage').onload = () => { calcCropBounds(); renderCropUI(); };
            window.removeEventListener('resize', resizeCrop); window.addEventListener('resize', resizeCrop);
        }

        function resizeCrop() { if(!el('cropView').classList.contains('hide')) { calcCropBounds(); renderCropUI(); } }

        function calcCropBounds() {
            let container = el('cropContainer'); let cw = container.clientWidth; let ch = container.clientHeight;
            cropScale = Math.min(cw / cropImgBaseW, ch / cropImgBaseH);
            let scaledW = cropImgBaseW * cropScale; let scaledH = cropImgBaseH * cropScale;
            cropOffsetX = (cw - scaledW) / 2; cropOffsetY = (ch - scaledH) / 2;
            el('cropImage').style.width = `${scaledW}px`; el('cropImage').style.height = `${scaledH}px`;
            el('cropImage').style.left = `${cropOffsetX}px`; el('cropImage').style.top = `${cropOffsetY}px`;
        }

        function renderCropUI() {
            let svgPts = cropPts.map(p => `${p.x * cropScale + cropOffsetX},${p.y * cropScale + cropOffsetY}`).join(" ");
            el('cropPolygon').setAttribute('points', svgPts);
            for(let i=0; i<4; i++) {
                let sx = cropPts[i].x * cropScale + cropOffsetX; let sy = cropPts[i].y * cropScale + cropOffsetY;
                el('pt'+i).style.transform = `translate(${sx}px, ${sy}px)`;
            }
        }

        const getEvtCoords = (e) => (e.touches && e.touches.length > 0) ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };

        for(let i=0; i<4; i++) {
            const startDrag = (e) => { e.preventDefault(); activePtIndex = i; };
            el('pt'+i).addEventListener('mousedown', startDrag); el('pt'+i).addEventListener('touchstart', startDrag, {passive: false});
        }

        const moveDrag = (e) => {
            if (activePtIndex === -1) return;
            e.preventDefault();
            let coords = getEvtCoords(e); let rect = el('cropContainer').getBoundingClientRect();
            let sx = coords.x - rect.left; let sy = coords.y - rect.top;
            let imgX = (sx - cropOffsetX) / cropScale; let imgY = (sy - cropOffsetY) / cropScale;
            imgX = Math.max(0, Math.min(imgX, cropImgBaseW)); imgY = Math.max(0, Math.min(imgY, cropImgBaseH));
            cropPts[activePtIndex] = {x: imgX, y: imgY};
            renderCropUI();
        };

        const endDrag = () => { activePtIndex = -1; };

        el('cropContainer').addEventListener('mousemove', moveDrag); el('cropContainer').addEventListener('touchmove', moveDrag, {passive: false});
        window.addEventListener('mouseup', endDrag); window.addEventListener('touchend', endDrag);

        el('cancelCropBtn').addEventListener('click', () => { el('cropView').classList.add('hide'); el('cameraView').classList.remove('hide'); });

        el('confirmCropBtn').addEventListener('click', () => {
            showToast("Enhancing document...", "info");
            setTimeout(() => {
                let finalDataUrl = flattenDocument(currentCropCanvas, cropPts);
                
                // Store as object with filter properties
                scannedPages.push({
                    originalDataUrl: finalDataUrl,
                    displayDataUrl: finalDataUrl,
                    filter: 'original',
                    brightness: 100
                });
                
                // Process to ensure it meets standard (just draws it cleanly)
                processImageCanvas(scannedPages.length - 1);

                el('cropView').classList.add('hide'); el('cameraView').classList.remove('hide');
                updateUI(); showToast("Page Scanned!", "success");
            }, 50);
        });

        // ==========================================
        // IMAGE FILTERING & PROCESSING LOGIC
        // ==========================================
        let processTimeout;

        // Visual Preview via CSS (Fast, 60fps)
        function updateCssPreview(pageIndex) {
            const page = scannedPages[pageIndex];
            const imgEl = el('viewerImage');
            
            if (page.filter === 'original') {
                imgEl.style.filter = `brightness(${page.brightness}%)`;
            } else if (page.filter === 'grayscale') {
                imgEl.style.filter = `brightness(${page.brightness}%) grayscale(100%)`;
            } else if (page.filter === 'bw') {
                // High contrast hack for pure CSS B&W preview
                imgEl.style.filter = `brightness(${page.brightness}%) grayscale(100%) contrast(500%)`;
            }
        }

        // Deep Canvas Processing (Generates final Base64 image)
        function processImageCanvas(pageIndex) {
            const page = scannedPages[pageIndex];
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext('2d');

                // Draw base image with brightness & standard gray adjustments
                if (page.filter === 'bw' || page.filter === 'grayscale') {
                    ctx.filter = `brightness(${page.brightness}%) grayscale(100%)`;
                } else {
                    ctx.filter = `brightness(${page.brightness}%)`;
                }
                ctx.drawImage(img, 0, 0);

                // Manual Thresholding for pure Black & White
                if (page.filter === 'bw') {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = data[i]; // already grayscale, so R=G=B
                        const val = avg >= 128 ? 255 : 0;
                        data[i] = val; data[i+1] = val; data[i+2] = val;
                    }
                    ctx.putImageData(imageData, 0, 0);
                }

                // Save processed string
                page.displayDataUrl = canvas.toDataURL('image/jpeg', 0.85);
                
                // Update UI if user is actively looking at this page
                if (viewerIndex === pageIndex && !el('viewerView').classList.contains('hide')) {
                    el('viewerImage').style.filter = 'none'; // remove CSS preview
                    el('viewerImage').src = page.displayDataUrl;
                }
                
                // Update Thumbnail if it's the latest
                if (pageIndex === scannedPages.length - 1) {
                    el('lastThumb').src = page.displayDataUrl;
                }
            };
            img.src = page.originalDataUrl;
        }

        // UI Listeners for Filters
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const filter = e.target.dataset.filter;
                if(scannedPages.length === 0) return;
                
                scannedPages[viewerIndex].filter = filter;
                updateView(); // refresh active button states
                
                el('viewerImage').style.filter = 'none'; // Clear CSS before deep process
                processImageCanvas(viewerIndex);
            });
        });

        // UI Listener for Brightness (Debounced)
        el('brightnessSlider').addEventListener('input', (e) => {
            if(scannedPages.length === 0) return;
            const val = e.target.value;
            scannedPages[viewerIndex].brightness = val;
            
            updateCssPreview(viewerIndex); // Instant visual feedback
            
            clearTimeout(processTimeout);
            processTimeout = setTimeout(() => {
                processImageCanvas(viewerIndex); // Finalize data after 300ms
            }, 300);
        });


        // OpenCV Flatten Document
        function findDocumentCorners(srcCanvas) {
            if (!window.cvReady) return null;
            try {
                let src = cv.imread(srcCanvas); let dst = new cv.Mat();
                let scale = Math.min(500 / src.cols, 500 / src.rows);
                cv.resize(src, dst, new cv.Size(src.cols * scale, src.rows * scale), 0, 0, cv.INTER_AREA);
                cv.cvtColor(dst, dst, cv.COLOR_RGBA2GRAY, 0); cv.GaussianBlur(dst, dst, new cv.Size(5, 5), 0, 0, cv.BORDER_DEFAULT); cv.Canny(dst, dst, 75, 200);
                let contours = new cv.MatVector(); let hierarchy = new cv.Mat();
                cv.findContours(dst, contours, hierarchy, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);
                let maxArea = 0; let bestApprox = null;
                for (let i = 0; i < contours.size(); ++i) {
                    let cnt = contours.get(i); let area = cv.contourArea(cnt);
                    if (area > 1000) { 
                        let approx = new cv.Mat(); cv.approxPolyDP(cnt, approx, 0.02 * cv.arcLength(cnt, true), true);
                        if (approx.rows === 4 && cv.isContourConvex(approx)) {
                            if (area > maxArea) { maxArea = area; if (bestApprox) bestApprox.delete(); bestApprox = approx; } else approx.delete();
                        } else approx.delete();
                    } cnt.delete();
                }
                let result = null;
                if (bestApprox) {
                    result = []; for (let i = 0; i < 4; i++) result.push({ x: bestApprox.data32S[i * 2] / scale, y: bestApprox.data32S[i * 2 + 1] / scale });
                    bestApprox.delete();
                }
                src.delete(); dst.delete(); contours.delete(); hierarchy.delete();
                return result ? orderPoints(result) : null;
            } catch (err) { return null; }
        }

        function orderPoints(pts) {
            let rect = new Array(4);
            let s = pts.map(p => p.x + p.y); let tlIndex = s.indexOf(Math.min(...s)); let brIndex = s.indexOf(Math.max(...s));
            rect[0] = pts[tlIndex]; rect[2] = pts[brIndex];
            let diff = pts.map(p => p.y - p.x); let remaining = [0, 1, 2, 3].filter(i => i !== tlIndex && i !== brIndex);
            if (diff[remaining[0]] < diff[remaining[1]]) { rect[1] = pts[remaining[0]]; rect[3] = pts[remaining[1]]; } 
            else { rect[1] = pts[remaining[1]]; rect[3] = pts[remaining[0]]; }
            return rect;
        }

        function flattenDocument(srcCanvas, pts) {
            if (!window.cvReady) return srcCanvas.toDataURL('image/jpeg', 0.85); 
            try {
                let src = cv.imread(srcCanvas);
                let tl = pts[0], tr = pts[1], br = pts[2], bl = pts[3];
                let maxWidth = Math.max(Math.hypot(br.x - bl.x, br.y - bl.y), Math.hypot(tr.x - tl.x, tr.y - tl.y));
                let maxHeight = Math.max(Math.hypot(tr.x - br.x, tr.y - br.y), Math.hypot(tl.x - bl.x, tl.y - bl.y));
                let dst = new cv.Mat();
                let M = cv.getPerspectiveTransform( cv.matFromArray(4, 1, cv.CV_32FC2, [ tl.x, tl.y, tr.x, tr.y, br.x, br.y, bl.x, bl.y ]), cv.matFromArray(4, 1, cv.CV_32FC2, [ 0, 0, maxWidth, 0, maxWidth, maxHeight, 0, maxHeight ]) );
                cv.warpPerspective(src, dst, M, new cv.Size(maxWidth, maxHeight), cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
                let tmpCanvas = document.createElement('canvas'); cv.imshow(tmpCanvas, dst);
                let dataUrl = tmpCanvas.toDataURL('image/jpeg', 0.85);
                src.delete(); dst.delete(); M.delete(); return dataUrl;
            } catch (err) { return srcCanvas.toDataURL('image/jpeg', 0.85); }
        }

        // ==========================================
        // VIEWER & EXPORT LOGIC
        // ==========================================
        function showViewer() {
            el('cameraView').classList.add('hide'); el('viewerView').classList.remove('hide');
            viewerIndex = scannedPages.length - 1; updateView();
        }

        function updateView() {
            if (scannedPages.length === 0) return;
            const page = scannedPages[viewerIndex];
            
            el('viewerImage').style.filter = 'none'; // remove residual css previews
            el('viewerImage').src = page.displayDataUrl;
            
            el('pageIndicator').textContent = `${viewerIndex + 1} / ${scannedPages.length}`;
            el('prevPageBtn').disabled = viewerIndex === 0;
            el('nextPageBtn').disabled = viewerIndex === scannedPages.length - 1;
            
            el('brightnessSlider').value = page.brightness;
            
            // Update Filter Buttons UI
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === page.filter) {
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow');
                    btn.classList.remove('text-gray-400', 'bg-transparent');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow');
                    btn.classList.add('text-gray-400', 'bg-transparent');
                }
            });
        }

        el('goToViewerBtn').addEventListener('click', showViewer);
        el('backToCameraBtn').addEventListener('click', () => { el('viewerView').classList.add('hide'); el('cameraView').classList.remove('hide'); });
        
        el('prevPageBtn').addEventListener('click', () => { 
            if (viewerIndex > 0) { clearTimeout(processTimeout); viewerIndex--; updateView(); } 
        });
        el('nextPageBtn').addEventListener('click', () => { 
            if (viewerIndex < scannedPages.length - 1) { clearTimeout(processTimeout); viewerIndex++; updateView(); } 
        });

        el('newScanBtn').addEventListener('click', () => {
            if(scannedPages.length > 0 && !confirm("Discard these pages and start a new scan?")) return;
            scannedPages = []; viewerIndex = 0; updateUI();
            el('viewerView').classList.add('hide'); el('cameraView').classList.remove('hide');
            el('docTitleInput').value = ''; showToast("Ready for a new document", "success");
        });

        async function buildPDF() {
            if (scannedPages.length === 0) throw new Error("No pages");
            const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit: 'in', format: 'letter' });
            for (let i = 0; i < scannedPages.length; i++) {
                if (i > 0) doc.addPage();
                
                // Use the processed display data url
                const imgData = scannedPages[i].displayDataUrl;
                
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth(); const pdfHeight = doc.internal.pageSize.getHeight();
                let imgWidth = pdfWidth; let imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                if (imgHeight > pdfHeight) { imgHeight = pdfHeight; imgWidth = (imgProps.width * pdfHeight) / imgProps.height; }
                doc.addImage(imgData, 'JPEG', (pdfWidth - imgWidth) / 2, (pdfHeight - imgHeight) / 2, imgWidth, imgHeight);
            }
            return doc;
        }

        el('exportPdfBtn').addEventListener('click', async () => {
            if(scannedPages.length === 0) return; showToast("Generating PDF...", "info");
            try { const doc = await buildPDF(); doc.save(`DocuScan_${new Date().getTime()}.pdf`); showToast("PDF Downloaded!", "success"); } 
            catch(e) { showToast("PDF Error", "error"); }
        });

        el('exportJpgBtn').addEventListener('click', () => {
            if(scannedPages.length === 0) return;
            const link = document.createElement('a'); link.download = `Page_${viewerIndex + 1}.jpg`; 
            link.href = scannedPages[viewerIndex].displayDataUrl; // Ensure we export the processed image
            document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast("Image Downloaded!", "success");
        });

        // ==========================================
        // DRIVE UPLOAD LOGIC
        // ==========================================
        el('triggerDriveBtn').addEventListener('click', () => { 
            if (!navigator.onLine) return showToast("Network unavailable. Please use Save PDF/JPG locally.", "error");
            if(scannedPages.length === 0) return; 
            el('saveModal').classList.remove('hide'); 
        });
        
        el('cancelSaveBtn').addEventListener('click', () => el('saveModal').classList.add('hide'));

        el('confirmSaveBtn').addEventListener('click', async () => {
            if (!navigator.onLine) return showToast("Network disconnected.", "error");
            if (!GOOGLE_APPS_SCRIPT_URL.includes("script.google.com")) return alert("Please add your Apps Script URL.");
            const title = el('docTitleInput').value.trim() || 'Untitled Scan'; const format = el('formatSelect').value;
            el('saveModal').classList.add('hide'); showToast("Preparing file...", "info");
            
            let payload = { action: 'save', username: currentUser, password: currentPassword, title: title, format: format };
            try {
                if (format === 'pdf') { 
                    const doc = await buildPDF(); payload.file = doc.output('datauristring'); 
                } 
                else { 
                    payload.pages = scannedPages.map(p => p.displayDataUrl); // Upload processed images
                }
                
                showToast("Uploading to Drive...", "info");
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.success) showToast("Uploaded successfully!", "success"); else throw new Error(result.error);
            } catch (err) { showToast("Upload failed.", "error"); }
        });

        // ==========================================
        // MY FILES VIEWER LOGIC
        // ==========================================
        el('viewDriveBtn').addEventListener('click', async () => {
            if (!navigator.onLine) return showToast("Cannot view Drive files offline.", "error");
            if (!GOOGLE_APPS_SCRIPT_URL.includes("script.google.com")) return alert("Please add your Apps Script URL.");
            const container = el('filesListContainer'); el('filesModal').classList.remove('hide');
            container.innerHTML = '<div class="text-center text-gray-400 py-12"><i class="ph ph-spinner animate-spin text-3xl mb-3 text-blue-500"></i><br>Fetching your files...</div>';

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'list_files', username: currentUser, password: currentPassword }) });
                const result = await response.json();
                if (result.success) {
                    if (result.files.length === 0) container.innerHTML = '<div class="text-center text-gray-400 py-10">No files found.</div>';
                    else {
                        container.innerHTML = result.files.map(f => `
                            <a href="${f.url}" target="_blank" class="flex items-center gap-4 p-3 bg-gray-900 rounded-xl hover:bg-gray-700 transition-colors border border-gray-700 mb-2 no-underline text-white">
                                <div class="${f.type === 'folder' ? 'text-yellow-400' : 'text-red-400'} text-3xl"><i class="ph ${f.type === 'folder' ? 'ph-folder' : 'ph-file-pdf'}"></i></div>
                                <div class="flex-1 overflow-hidden">
                                    <div class="text-sm font-semibold truncate">${f.name}</div>
                                    <div class="text-xs text-gray-400 mt-1">${new Date(f.date).toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                                </div>
                                <i class="ph ph-arrow-square-out text-gray-400 text-lg"></i>
                            </a>
                        `).join('');
                    }
                } else throw new Error(result.error);
            } catch (err) { container.innerHTML = '<div class="text-center text-red-400 py-10">Failed to load files.</div>'; }
        });

        el('closeFilesBtn').addEventListener('click', () => el('filesModal').classList.add('hide'));

    </script>
</body>
</html>


